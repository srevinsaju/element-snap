name: element-desktop
version: '1.7.2'
summary: Glossy Matrix collaboration client
description: |
  All-in-one secure chat app for teams, friends and organisations. 
  Keeps conversations in your control, safe from data-mining and ads. 
  Talk to everyone through the open global Matrix network, 
  protected by proper end-to-end encryption.

grade: stable
confinement: strict
base: core18
architectures:
- build-on: amd64

parts:
  element-desktop:
    plugin: nodejs
    source: https://github.com/vector-im/riot-desktop
    source-type: git
    stage-packages:
      - libasound2
      - libgconf2-4
      - libnotify4
      - libnspr4
      - libnss3
      - libpcre3
      - libpulse0
      - libxss1
      - libxtst6
      - libappindicator1
      - libsecret-1-0
      - libgtk-3-0
      - libdb5.3
      - libsqlcipher-dev
    build-packages:
      - wget
    override-build: | 
      yarn install
      yarn run hak
      mkdir config && cd config
      wget https://raw.githubusercontent.com/vector-im/riot-web/develop/config.sample.json
      mv config.sample.json config.json && cd ..
      yarn run fetch --importkey
      yarn run fetch --cfgdir config
      wget https://raw.githubusercontent.com/srevinsaju/element-deb/master/appimage.js
      mv appimage.js src/.
      wget https://raw.githubusercontent.com/srevinsaju/element-deb/master/patch.sh
      chmod +x patch.sh
      ./patch.sh

    stage:
      - -lib/node_modules/*
      - -usr/share/doc/*
      - -usr/share/man/*
      - -share/man/*
      - -share/doc/*
      - -README.md

apps:
  element-desktop:
    command: bin/desktop-launch $SNAP/bin/element-desktop 
    plugs: [home, network, network-observe, x11, wayland, opengl, desktop, desktop-legacy, unity7, gsettings, browser-support]
 
